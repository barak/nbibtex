#!/bin/sh

DESTDIR=
PREFIX=usr/local
debian=

while [ $# -gt 0 ]
do
  case $1 in
    --help)
       cat 1>&2 <<EOF
Usage: $0 [options]

Options:
  --help       This message
  --debian     Configure to build debian package
  --prefix==  Set installation prefix [default $PREFIX]
EOF
      exit 0
      ;;
   --prefix=*) PREFIX="`echo $2 | sed 's/.*=//'`" ; shift ; shift ;;
   --debian) debian=1 ; PREFIX=usr ; shift ;;
   *) echo "Usage: $0 -- help"; exit 1 ;;
  esac
done
      
######################################################################33
#
# search for lua

CF=
LF=

if [ -x "`which pkg-config 2>/dev/null`" ]; then

  CF="`pkg-config --cflags lua50`"
  LF="`pkg-config --libs   lua50`"

  if [ -z "$CF" ]; then
    echo "Don't know how to find include files for Lua 5.0"; exit 1
  fi

  if [ -z "$LF" ]; then
    echo "Don't know how to find libraries for Lua 5.0"; exit 1
  fi

  LF="$LF `pkg-config --libs   lualib50`"

fi

LUAI="/usr/include/lua50 /usr/local/include/lua50 /usr/include /usr/local/include"
LUAI="$LUAI /usr/local/lua50/include /usr/local/lua/include /usr/include/lua"

LIBS="/lib /usr/lib /usr/local/lib"

if [ -z "$CF" ]; then
  for i in $LUAI; do
    if [ -r $i/lua.h ] && grep 'LUA_VERSION.* 5\.0' $i/lua.h > /dev/null; then
      CF="-I$i"
      break
    fi
  done
fi

if [ -z "$LF" ]; then
  L1=
  L2=
  for i in $LIBS; do
    if [ -r $i/liblua50.so ]; then
      LF="-L$i"
      L1="-lliblua50"
      break
    fi
  done
  for i in $LIBS; do
    if [ -r $i/liblualib50.so ]; then
      if [ "x$LF" != "x-L$i" ]; then LF="$LF -L$i"; fi
      L2="-lliblualib50"
      break
    fi
  done
  if [ -z "$L1" ]; then
    for i in $LIBS; do
      if [ -r $i/liblua.so ]; then
        if [ "x$LF" != "x-L$i" ]; then LF="$LF -L$i"; fi
        L1="-lliblua"
        break
      fi
    done
  fi
  if [ -z "$L2" ]; then
    for i in $LIBS; do
      if [ -r $i/liblualib.so ]; then
        if [ "x$LF" != "x-L$i" ]; then LF="$LF -L$i"; fi
        L2="-lliblualib"
        break
      fi
    done
  fi
  if [ -n "$L1" -a -n "$L2" ]; then
    LF="$LF $L1 $L2"
  else
    LF=
  fi
fi

if [ -z "$CF" ]; then
  echo "Don't know how to find include files for Lua 5.0"; exit 1
fi

if [ -z "$LF" ]; then
  echo "Don't know how to find libraries for Lua 5.0"; exit 1
fi

echo "Lua: OK"

################################################################

if [ -z "$debian" ]; then
  setdest="DESTDIR=$DESTDIR"
else
  setdest=
fi

cat <<EOF > Makefile
$setdest
prefix=$PREFIX
EOF

cat <<'XXX' >> Makefile
SHARE=$(DESTDIR)/$(prefix)/share/nbibtex
BIN=$(DESTDIR)/$(prefix)/bin
MAN1=$(DESTDIR)/$(prefix)/share/man/man1

XXX

dollar='$'

cat <<EOF >> Makefile
CFLAGS=$CF -DSHARE='"$dollar(SHARE)"'
LDFLAGS=$LF

EOF

cat Makefile.in >> Makefile

cat <<EOF - bibtex.lua.in > bibtex.lua
local config = { nbs = "$SHARE" }
EOF
